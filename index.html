<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>JMVEST Finanzcheck â€“ Premium UI</title>

<!-- Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js" defer></script>

<style>
  :root{
    /* Brand */
    --brand-700:#0e3c22;
    --brand-600:#134e2d;
    --brand-500:#1b6a40;
    --accent-500:#3b82f6;
    --ink:#0f172a;
    --muted:#64748b;
    --outline:#e2e8f0;
    --success:#16a34a;
    --warning:#f59e0b;
    --danger:#ef4444;

    /* Surfaces */
    --bg: radial-gradient(1200px 600px at 10% -10%, #c7f9cc22 0%, transparent 60%),
          radial-gradient(1200px 600px at 110% 10%, #b1e3ff22 0%, transparent 60%),
          linear-gradient(180deg, #f7faf9 0%, #eef3f2 100%);
    --card: rgba(255,255,255,0.86);
    --glass: blur(10px) saturate(120%);
    --shadow-lg: 0 20px 45px rgba(16,24,40,.08);
    --shadow-md: 0 10px 25px rgba(16,24,40,.06);
    --radius-xl: 18px;
    --radius-lg: 14px;
    --radius-md: 12px;
  }

  *{ box-sizing:border-box }
  html,body{ height:100% }
  body{
    margin:0;
    font-family:'Inter', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    color:var(--ink);
    background:var(--bg);
  }

  /* Header */
  .hero{
    position:relative; padding:38px 20px 10px; text-align:center;
  }
  .brand{
    display:flex; align-items:center; justify-content:center; gap:10px;
    color:var(--brand-600);
  }
  .brand-logo{
    width:42px; height:42px; border-radius:12px;
    background:linear-gradient(135deg, var(--brand-600), var(--brand-500));
    box-shadow:0 10px 18px rgba(19,78,45,.25), inset 0 0 0 2px rgba(255,255,255,.25);
    display:grid; place-items:center; color:white; font-weight:800;
  }
  h1{ margin:8px 0 6px; font-size: clamp(26px, 2vw + 14px, 34px); letter-spacing: .2px }
  .hero p{ margin:0; color:var(--muted) }

  /* Layout */
  .wrap{ max-width:1200px; margin:22px auto 40px; padding:0 20px }
  .grid{ display:grid; grid-template-columns: 1fr 1.2fr; gap:22px }
  @media (max-width: 980px){ .grid{ grid-template-columns:1fr } }

  /* Cards (glassmorphism) */
  .card{
    background:var(--card);
    -webkit-backdrop-filter: var(--glass);
    backdrop-filter: var(--glass);
    border:1px solid rgba(226,232,240,.8);
    border-radius:var(--radius-xl);
    box-shadow: var(--shadow-lg);
  }
  .card .pad{ padding:22px }
  .divider{ height:1px; background:var(--outline); margin:12px 0 6px; opacity:.7 }

  /* Form */
  .form-title{
    font-weight:800; font-size:1.05rem; letter-spacing:.2px; color:var(--brand-600);
    display:flex; align-items:center; gap:10px;
  }
  .row{ display:grid; grid-template-columns:1fr 1fr; gap:14px }
  @media (max-width: 640px){ .row{ grid-template-columns:1fr } }

  label{ display:block; font-weight:600; margin-top:12px }
  .hint{ font-size:.85rem; color:var(--muted); margin-top:4px }
  .field{
    margin-top:8px; position:relative;
  }
  input[type="number"], select, input[type="range"]{
    width:100%; border-radius:12px; padding:13px 14px; border:1px solid var(--outline); background:#fff;
    font-size:1rem; transition: box-shadow .2s, border-color .2s, transform .02s;
    box-shadow: 0 1px 0 rgba(2,8,23,.02);
  }
  input[type="number"]:focus, select:focus, input[type="range"]:focus{
    outline:none; border-color:var(--accent-500);
    box-shadow: 0 0 0 3px rgba(59,130,246,.18);
  }
  input[type="range"]{ padding:0; height:36px; -webkit-appearance:none; background:transparent }
  input[type="range"]::-webkit-slider-runnable-track{ height:8px; border-radius:10px; background:linear-gradient(90deg,#e2e8f0,#cbd5e1) }
  input[type="range"]::-webkit-slider-thumb{
    -webkit-appearance:none; width:22px; height:22px; border-radius:50%;
    background:linear-gradient(135deg, var(--brand-600), var(--brand-500));
    border:2px solid #fff; margin-top:-7px; box-shadow:0 6px 12px rgba(19,78,45,.25);
    transition: transform .08s ease;
  }
  input[type="range"]:active::-webkit-slider-thumb{ transform: scale(1.05) }

  .range-meta{ display:flex; align-items:center; justify-content:space-between; margin-top:6px; color:var(--muted); font-size:.9rem }

  .switch{ display:flex; align-items:center; gap:10px; margin-top:10px }
  .switch input{ width:auto }
  .btn{
    display:inline-flex; align-items:center; justify-content:center; gap:8px;
    width:100%; border:none; padding:14px 16px; margin-top:16px;
    border-radius:14px; font-weight:700; font-size:1.05rem; letter-spacing:.2px;
    cursor:pointer; color:#fff; background:linear-gradient(135deg, var(--brand-600), var(--brand-500));
    box-shadow: 0 12px 24px rgba(19,78,45,.25);
    transition: transform .06s ease, filter .2s ease, opacity .2s ease;
  }
  .btn:hover{ filter:brightness(1.03) }
  .btn:active{ transform: translateY(1px) }
  .btn.secondary{
    color:var(--ink);
    background:linear-gradient(135deg, #e7eef5, #dde7ee);
    box-shadow: 0 8px 18px rgba(2,8,23,.06);
  }

  .error{ color:var(--danger); font-weight:700; margin-top:10px; display:none }

  /* Results */
  .heading{
    display:flex; align-items:center; justify-content:space-between; gap:12px;
    flex-wrap:wrap;
  }
  .pill{
    display:inline-flex; align-items:center; gap:8px;
    padding:8px 12px; border-radius:999px;
    background:linear-gradient(135deg, #e7f5ec, #dff1e7);
    color:var(--brand-600); font-weight:700;
    border: 1px solid #cde8d7;
  }
  .kpis{
    display:grid; grid-template-columns:repeat(3,1fr); gap:12px; margin-top:14px;
  }
  .kpi{
    background:linear-gradient(180deg, #ffffff, #f6fbff);
    border:1px solid var(--outline); border-radius:14px; padding:14px;
    box-shadow: var(--shadow-md);
  }
  .kpi .lbl{ font-size:.85rem; color:var(--muted) }
  .kpi .val{ font-size:1.25rem; font-weight:800; letter-spacing:.2px }
  .kpi .sub{ font-size:.8rem; color:var(--muted) }

  .progress{ margin:16px 0 6px; height:14px; background:#eef2f7; border-radius:999px; overflow:hidden; border:1px solid #e2e8f0 }
  .progress > div{
    height:100%; width:0%;
    background:linear-gradient(90deg, #22c55e, #16a34a);
    box-shadow: inset 0 0 10px rgba(255,255,255,.35);
    transition:width .6s cubic-bezier(.2,.7,.2,1);
  }
  .progress-note{ font-size:.92rem; color:var(--muted) }

  .section-caption{ font-weight:700; color:#111827; margin:12px 0 8px }
  .note{ background:#fffdf7; border:1px dashed #f59e0b55; color:#7c4a03; padding:10px 12px; border-radius:12px }

  .callout{ border-left:6px solid var(--brand-600); background:#edf7f1; border:1px solid #cde8d7; padding:12px; border-radius:12px; }

  .rec{ border-radius:14px; padding:12px; border:1px solid var(--outline); margin-top:10px }
  .rec.ok{ background:#ecfdf5; border-color:#bbf7d0; color:#065f46 }
  .rec.warn{ background:#fff7ed; border-color:#fed7aa; color:#7c2d12 }
  .rec.bad{ background:#fef2f2; border-color:#fecaca; color:#7f1d1d }

  .charts{ display:grid; grid-template-columns: 1fr; gap:14px; margin-top:12px }
  .chart-card{ background:#fff; border:1px solid var(--outline); border-radius:14px; padding:12px; box-shadow:var(--shadow-md) }
  canvas{ max-width:100%; height:auto }

  .foot{ text-align:center; color:var(--muted); font-size:.9rem; padding:20px 0 30px }
</style>
</head>
<body>
  <section class="hero">
    <div class="brand">
      <div class="brand-logo">JM</div>
      <div>
        <h1>JMVEST Finanzcheck</h1>
        <p>Motivier dich & plane realistisch â€“ klar, schnell und schÃ¶n.</p>
      </div>
    </div>
  </section>

  <main class="wrap">
    <div class="grid">
      <!-- FORM -->
      <form id="financeForm" class="card" novalidate aria-describedby="formHelp">
        <div class="pad">
          <div class="form-title">Eingaben</div>

          <label for="income">ğŸ’° Monatliches Nettoeinkommen (â‚¬)</label>
          <div class="field"><input type="number" id="income" min="0" inputmode="decimal" placeholder="z.â€¯B. 2.800" required></div>
          <p class="hint">Netto pro Monat.</p>

          <label for="expenses">ğŸ  Monatliche Fixkosten (â‚¬)</label>
          <div class="field"><input type="number" id="expenses" min="0" inputmode="decimal" placeholder="z.â€¯B. 1.400" required></div>
          <p class="hint">Miete, Versicherungen, Abos, Ã–PNV â€¦</p>

          <div class="row">
            <div>
              <label for="lifestyle">ğŸ§­ Lebensstil (% variabler Konsum)</label>
              <div class="field">
                <input type="range" id="lifestyle" min="0" max="60" step="5" value="20">
              </div>
              <div class="range-meta"><span>0%</span><strong><span id="lifestyleVal">20</span>%</strong><span>60%</span></div>
            </div>
            <div>
              <label for="assets">ğŸ’¼ Investierbares VermÃ¶gen (â‚¬)</label>
              <div class="field"><input type="number" id="assets" min="0" value="0" inputmode="decimal"></div>
              <p class="hint">Depot / Tagesgeld.</p>
            </div>
          </div>

          <div class="divider"></div>

          <label for="goal">ğŸ¯ Ziel</label>
          <div class="field">
            <select id="goal" required>
              <option value="Eigenheim" data-amount="300000">ğŸ¡ Eigenheim (300.000 â‚¬)</option>
              <option value="FrÃ¼h in Rente" data-amount="500000">ğŸ–ï¸ FrÃ¼h in Rente (500.000 â‚¬)</option>
              <option value="VermÃ¶gensaufbau" data-amount="200000" selected>ğŸ“ˆ VermÃ¶gensaufbau (200.000 â‚¬)</option>
              <option value="Kinder Studium" data-amount="100000">ğŸ“ Studium der Kinder (100.000 â‚¬)</option>
              <option value="Weltreise" data-amount="30000">ğŸŒ Weltreise (30.000 â‚¬)</option>
              <option value="Finanzielle UnabhÃ¤ngigkeit" data-amount="1000000">ğŸ’¸ Finanzielle UnabhÃ¤ngigkeit (1.000.000 â‚¬)</option>
              <option value="Eigenes Ziel">âœï¸ Eigenes Ziel â€¦</option>
            </select>
          </div>

          <div id="customGoalWrap" style="display:none">
            <label for="customGoal">Eigenes Ziel (â‚¬)</label>
            <div class="field"><input type="number" id="customGoal" min="1" placeholder="z.â€¯B. 250.000"></div>
          </div>

          <div class="row">
            <div>
              <label for="risk">ğŸ“ˆ Risikoprofil</label>
              <div class="field">
                <select id="risk" required>
                  <option value="0.025">ğŸ‚ Sehr gering (2,5% p.a.)</option>
                  <option value="0.055">ğŸ Defensiv Klassisch (5,5% p.a.)</option>
                  <option value="0.065">ğŸ€ Defensiv Innovativ (6,5% p.a.)</option>
                  <option value="0.075">ğŸŒ± Ausgewogen Klassisch (7,5% p.a.)</option>
                  <option value="0.090">ğŸŒ³ Ausgewogen Innovativ (9% p.a.)</option>
                  <option value="0.095">ğŸŒ² Wachstum Klassisch (9,5% p.a.)</option>
                  <option value="0.125">ğŸŒ´ Wachstum Innovativ (12,5% p.a.)</option>
                  <option value="0.160">ğŸ”¥ Max. Wachstum (16% p.a.)</option>
                </select>
              </div>
            </div>
            <div>
              <label for="duration">â³ Zeithorizont (Jahre)</label>
              <div class="field"><input type="range" id="duration" min="1" max="30" step="1" value="15"></div>
              <div class="range-meta"><span>1</span><strong><span id="durationVal">15</span> Jahre</strong><span>30</span></div>
            </div>
          </div>

          <div class="row">
            <div class="switch">
              <input type="checkbox" id="inflation">
              <label for="inflation">ğŸ“‰ Inflation berÃ¼cksichtigen (2% p.a.)</label>
            </div>
            <div class="switch">
              <input type="checkbox" id="taxes">
              <label for="taxes">ğŸ’¶ Steuer berÃ¼cksichtigen (25% auf Gewinne)</label>
            </div>
          </div>

          <label for="debt">ğŸ“‰ Schulden</label>
          <div class="field">
            <select id="debt" required>
              <option value="Keine">Keine</option>
              <option value="Konsumschulden">Konsumschulden</option>
              <option value="Studienkredite">Studienkredite</option>
              <option value="Immobilienkredite">Immobilienschulden</option>
            </select>
          </div>

          <div class="row">
            <div>
              <label for="emMonths">ğŸ›Ÿ Notgroschen (Monate)</label>
              <div class="field"><input type="range" id="emMonths" min="0" max="12" step="1" value="3"></div>
              <div class="range-meta"><span>0</span><strong><span id="emMonthsVal">3</span> Monate</strong><span>12</span></div>
            </div>
            <div>
              <label for="liquid">ğŸ’§ Bereits vorhandene RÃ¼cklagen (â‚¬)</label>
              <div class="field"><input type="number" id="liquid" min="0" value="0" inputmode="decimal"></div>
            </div>
          </div>

          <button type="submit" class="btn">ğŸš€ Check starten</button>
          <button type="button" id="resetBtn" class="btn secondary">ZurÃ¼cksetzen</button>

          <p id="error" class="error" role="alert"></p>
          <p id="formHelp" class="hint" style="text-align:center;margin-top:12px">Deine Eingaben bleiben nur im Browser.</p>
        </div>
      </form>

      <!-- RESULTS -->
      <section id="result" class="card" aria-live="polite" aria-label="Ergebnis" data-visible="false">
        <div class="pad">
          <div class="heading">
            <h2 style="margin:0;font-size:1.15rem">Dein Ergebnis</h2>
            <div class="pill" id="badge">Profil: â€“</div>
          </div>

          <div class="kpis" role="group" aria-label="Kennzahlen">
            <div class="kpi">
              <div class="lbl">Monatlich investierbar</div>
              <div class="val" id="kpiMonthly">â€“</div>
              <div class="sub" id="kpiMonthlyPct"></div>
            </div>
            <div class="kpi">
              <div class="lbl">Zielbetrag</div>
              <div class="val" id="kpiGoal">â€“</div>
              <div class="sub" id="kpiGoalName"></div>
            </div>
            <div class="kpi">
              <div class="lbl">EndvermÃ¶gen (Investieren)</div>
              <div class="val" id="kpiFV">â€“</div>
              <div class="sub" id="kpiNote"></div>
            </div>
          </div>

          <div class="progress" aria-label="Ziel-Fortschritt">
            <div id="progressBar"></div>
          </div>
          <div class="progress-note" id="progressNote">Fortschritt: â€“</div>

          <div class="section-caption">Einordnung</div>
          <div class="callout" id="line3"></div>
          <div class="note" id="line2" style="margin-top:10px"></div>
          <div class="note" id="line1" style="margin-top:10px"></div>

          <div id="recommendation" class="rec" style="margin-top:12px"></div>
          <div id="debtTip" class="rec warn" style="display:none; margin-top:10px"></div>
          <div id="emTip" class="rec warn" style="display:none; margin-top:10px"></div>

          <div class="section-caption">Visualisierung</div>
          <div class="charts">
            <div class="chart-card"><canvas id="growthChart" aria-label="VermÃ¶gensentwicklung" role="img"></canvas></div>
            <div class="chart-card"><canvas id="splitChart" aria-label="Beitragsaufteilung" role="img"></canvas></div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <footer class="foot">
    Hinweis: Dieser Finanzcheck berÃ¼cksichtigt keine individuellen FreibetrÃ¤ge, GebÃ¼hren, Spreads oder persÃ¶nliche Steuersituationen. Die Ergebnisse sind NÃ¤herungen und keine Anlageberatung.
  </footer>

<script>
// ---------- Utilities ----------
const fmt0 = new Intl.NumberFormat('de-DE', { style:'currency', currency:'EUR', maximumFractionDigits: 0 });
const fmt2 = new Intl.NumberFormat('de-DE', { style:'currency', currency:'EUR', maximumFractionDigits: 2 });
const pct = (x) => new Intl.NumberFormat('de-DE', { style:'percent', maximumFractionDigits:1 }).format(x);

// Risk label
function riskLabel(r){
  const map = {
    0.025: "ğŸ‚ Sehr gering (2,5% p.a.)",
    0.055: "ğŸ Defensiv Klassisch (5,5% p.a.)",
    0.065: "ğŸ€ Defensiv Innovativ (6,5% p.a.)",
    0.075: "ğŸŒ± Ausgewogen Klassisch (7,5% p.a.)",
    0.09:  "ğŸŒ³ Ausgewogen Innovativ (9% p.a.)",
    0.095: "ğŸŒ² Wachstum Klassisch (9,5% p.a.)",
    0.125: "ğŸŒ´ Wachstum Innovativ (12,5% p.a.)",
    0.16:  "ğŸ”¥ Max. Wachstum (16% p.a.)"
  };
  return map[r] || (Math.round(r*1000)/10 + "% p.a.");
}

function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }

// Elements
const e = (id) => document.getElementById(id);
const form = e('financeForm');
const result = e('result');
const err = e('error');

const incomeEl = e('income');
const expensesEl = e('expenses');
const lifestyleEl = e('lifestyle');
const lifestyleVal = e('lifestyleVal');
const assetsEl = e('assets');
const goalEl = e('goal');
const customGoalWrap = e('customGoalWrap');
const customGoalEl = e('customGoal');
const riskEl = e('risk');
const durationEl = e('duration');
const durationVal = e('durationVal');
const inflationEl = e('inflation');
const taxesEl = e('taxes');
const debtEl = e('debt');
const emMonthsEl = e('emMonths');
const emMonthsVal = e('emMonthsVal');
const liquidEl = e('liquid');
const resetBtn = e('resetBtn');

const badge = e('badge');
const kpiMonthly = e('kpiMonthly');
const kpiMonthlyPct = e('kpiMonthlyPct');
const kpiGoal = e('kpiGoal');
const kpiGoalName = e('kpiGoalName');
const kpiFV = e('kpiFV');
const kpiNote = e('kpiNote');
const progressBar = e('progressBar');
const progressNote = e('progressNote');
const line1 = e('line1');
const line2 = e('line2');
const line3 = e('line3');
const rec = e('recommendation');
const debtTip = e('debtTip');
const emTip = e('emTip');

let growthChart, splitChart;

// Events
lifestyleEl.addEventListener('input', ()=> lifestyleVal.textContent = lifestyleEl.value);
durationEl.addEventListener('input', ()=> durationVal.textContent = durationEl.value);
emMonthsEl.addEventListener('input', ()=> emMonthsVal.textContent = emMonthsEl.value);

goalEl.addEventListener('change', ()=>{
  customGoalWrap.style.display = goalEl.value === 'Eigenes Ziel' ? 'block' : 'none';
  calculate();
});

[incomeEl, expensesEl, assetsEl, customGoalEl, riskEl, durationEl,
 lifestyleEl, inflationEl, taxesEl, debtEl, emMonthsEl, liquidEl].forEach(el=>{
  el.addEventListener('input', calculate);
  el.addEventListener('change', calculate);
});

form.addEventListener('submit', (ev)=>{
  ev.preventDefault();
  calculate(true);
  result.scrollIntoView({ behavior:'smooth', block:'start' });
});

resetBtn.addEventListener('click', ()=>{
  form.reset();
  lifestyleEl.value = 20; lifestyleVal.textContent = '20';
  durationEl.value = 15; durationVal.textContent = '15';
  emMonthsEl.value = 3; emMonthsVal.textContent = '3';
  customGoalWrap.style.display = 'none';
  err.style.display = 'none';
  clearCharts();
  result.dataset.visible = 'false';
  [kpiMonthly,kpiMonthlyPct,kpiGoal,kpiGoalName,kpiFV,kpiNote,progressNote,line1,line2,line3].forEach(n=> n.textContent='â€“');
  progressBar.style.width = '0%';
  rec.textContent = ''; rec.className = 'rec';
  debtTip.style.display = 'none';
  emTip.style.display = 'none';
});

// Core calc
function calculate(showErrors=false){
  const income = parseFloat(incomeEl.value);
  const expenses = parseFloat(expensesEl.value);
  const lifestylePct = parseFloat(lifestyleEl.value)/100;
  const assets = parseFloat(assetsEl.value||0);
  let annualReturn = parseFloat(riskEl.value);
  const years = parseInt(durationEl.value||0,10);
  const inflation = inflationEl.checked ? 0.02 : 0;
  const taxes = taxesEl.checked;
  const debt = debtEl.value;
  const emMonths = parseInt(emMonthsEl.value||0,10);
  const liquid = parseFloat(liquidEl.value||0);

  // Validation
  err.style.display = 'none';
  if (isNaN(income) || income <= 0){
    if (showErrors){ showError('Bitte gib ein gÃ¼ltiges monatliches Nettoeinkommen ein.'); }
    return;
  }
  if (isNaN(expenses) || expenses < 0){
    if (showErrors){ showError('Bitte gib gÃ¼ltige monatliche Fixkosten ein.'); }
    return;
  }
  if (expenses > income){
    if (showErrors){ showError('Fixkosten kÃ¶nnen nicht hÃ¶her als Einkommen sein.'); }
    return;
  }

  // Goal
  let goalName = goalEl.value;
  let goalAmount;
  if (goalName === 'Eigenes Ziel'){
    goalAmount = parseFloat(customGoalEl.value||0);
    if (!goalAmount && showErrors){
      showError('Bitte gib deinen individuellen Zielbetrag ein.');
      return;
    }
  } else {
    const opt = goalEl.selectedOptions[0];
    goalAmount = parseFloat(opt.dataset.amount);
  }

  // Monthly investable
  const monthlyAvailable = income - expenses - (income * lifestylePct);
  if (monthlyAvailable < 0){
    if (showErrors){ showError('Dein aktueller Lebensstil Ã¼berschreitet dein verfÃ¼gbares Einkommen.'); }
    return;
  }

  // Effective annual return (tax approx.)
  if (taxes){ annualReturn = annualReturn * (1 - 0.25); }
  const monthlyRate = annualReturn / 12;

  // Time in months
  const months = years * 12;
  let fv_noSaving = assets * Math.pow(1 + monthlyRate, months);
  let fv_saveNoInterest = assets + monthlyAvailable * months;
  let fv_invest = assets;
  for (let i=0; i<months; i++){ fv_invest = (fv_invest + monthlyAvailable) * (1 + monthlyRate); }

  // Inflation to today's money
  if (inflation > 0){
    const infl = Math.pow(1 + inflation, years);
    fv_noSaving /= infl;
    fv_saveNoInterest /= infl;
    fv_invest /= infl;
    goalAmount /= infl;
  }

  // Emergency fund
  const totalMonthlyOut = expenses + (income * lifestylePct);
  const emRequired = emMonths * totalMonthlyOut;
  const emGap = emRequired - liquid;
  const hasEmGap = emGap > 0.5;

  // KPIs
  badge.textContent = 'Profil: ' + riskLabel(parseFloat(riskEl.value));
  kpiMonthly.textContent = fmt2.format(monthlyAvailable);
  kpiMonthlyPct.textContent = `= ${pct(monthlyAvailable/Math.max(1,income))} vom Einkommen`;
  kpiGoal.textContent = fmt2.format(goalAmount);
  kpiGoalName.textContent = goalName;
  kpiFV.textContent = fmt2.format(fv_invest);
  kpiNote.textContent = `${years} Jahre${inflation>0?' â€¢ inflationsbereinigt':''}${taxes?' â€¢ nach Steuern':''}`;

  // Lines
  line3.textContent = `Mit Investieren erreichst du voraussichtlich ${fmt2.format(fv_invest)} (heutige Kaufkraft).`;
  line2.textContent = `Nur sparen (ohne Zinsen): ${fmt2.format(fv_saveNoInterest)} in ${years} Jahren.`;
  line1.textContent = `Ohne zusÃ¤tzliches Sparen (nur Zins auf vorhandenes VermÃ¶gen): ${fmt2.format(fv_noSaving)}.`;

  // Progress
  const progress = clamp((fv_invest / goalAmount) * 100, 0, 100);
  progressBar.style.width = progress.toFixed(1) + '%';
  progressNote.textContent = `Fortschritt: ${progress.toFixed(1)}% zum Ziel (${fmt2.format(goalAmount)}).`;

  // Recommendation
  const gap = fv_invest - goalAmount;
  rec.className = 'rec';
  if (gap >= 0){
    rec.classList.add('ok');
    rec.innerHTML = `ğŸ‰ Stark! Du erreichst dein Ziel. <strong>Ãœberschuss: ${fmt2.format(gap)}</strong>. 
      Behalte deine Rate bei oder ziehe eine frÃ¼here Zielerreichung in Betracht.`;
  } else {
    const short = -gap;
    const neededMonthly = solveForMonthlyPayment(assets, monthlyRate, months, goalAmount);
    const delta = Math.max(0, neededMonthly - monthlyAvailable);
    let hint = '';
    if (delta > 1){
      hint = ` ErhÃ¶he die Sparrate um ca. <strong>${fmt2.format(delta)}</strong>.`;
    } else {
      const moreYears = years + 5;
      const fvExtend = futureValue(assets, monthlyAvailable, monthlyRate, moreYears*12);
      if (fvExtend >= goalAmount){
        hint = ` VerlÃ¤ngere den Zeitraum auf <strong>${moreYears} Jahre</strong>.`;
      } else {
        hint = ` Oder wÃ¤hle ein hÃ¶heres Renditeprofil (mit mehr Schwankungen).`;
      }
    }
    rec.classList.add(short > goalAmount*0.3 ? 'bad' : 'warn');
    rec.innerHTML = `âš ï¸ Dir fehlen ca. <strong>${fmt2.format(short)}</strong>.${hint}`;
  }

  // Debt & Emergency notes
  if (debt !== 'Keine'){
    debtTip.style.display = 'block';
    debtTip.innerHTML = debtTipText(debt);
  } else {
    debtTip.style.display = 'none'; debtTip.textContent = '';
  }

  if (hasEmGap){
    emTip.style.display = 'block';
    emTip.innerHTML = `ğŸ’¡ Notgroschen-Empfehlung: ${emMonths}Ã— Ausgaben â‰ˆ <strong>${fmt2.format(emRequired)}</strong>.
      Es fehlen ca. <strong>${fmt2.format(emGap)}</strong> an liquiden RÃ¼cklagen.`;
  } else { emTip.style.display = 'none'; emTip.textContent = ''; }

  drawCharts({months, monthlyAvailable, assets, monthlyRate, fv_noSaving, fv_saveNoInterest, fv_invest, goalAmount});

  result.dataset.visible = 'true';
}

function showError(msg){ err.textContent = msg; err.style.display = 'block'; }

function debtTipText(type){
  switch(type){
    case 'Konsumschulden': return 'ğŸ’¡ Tipp: Tilge Konsumschulden zuerst â€“ Zinsen sind oft hÃ¶her als Anlagerenditen.';
    case 'Studienkredite': return 'ğŸ’¡ Tipp: Zahle planmÃ¤ÃŸig und prÃ¼fe Sondertilgungen (wenn zinsgÃ¼nstig).';
    case 'Immobilienkredite': return 'ğŸ’¡ Tipp: Solide Tilgung & RÃ¼cklagen fÃ¼r Instandhaltung einplanen.';
    default: return '';
  }
}

function solveForMonthlyPayment(PV, r, n, FV_target){
  if (r === 0){ const need = FV_target - PV; return need > 0 ? need / n : 0; }
  const a = Math.pow(1+r, n);
  return Math.max(0, (FV_target - PV*a) * (r / (a - 1)));
}
function futureValue(PV, PMT, r, n){
  if (r === 0) return PV + PMT*n;
  const a = Math.pow(1+r, n);
  return PV*a + PMT*((a-1)/r);
}

// Charts
function clearCharts(){ if (growthChart){ growthChart.destroy(); growthChart=null; } if (splitChart){ splitChart.destroy(); splitChart=null; } }
function drawCharts(ctx){
  const { months, monthlyAvailable, assets, monthlyRate, fv_noSaving, fv_saveNoInterest, fv_invest, goalAmount } = ctx;
  const labels = Array.from({length: months+1}, (_,i)=> i%12===0 ? (i/12).toString() : '');

  // Time series
  let s0=[assets], s1=[assets], s2=[assets];
  let v0=assets, v1=assets, v2=assets;
  for (let i=1; i<=months; i++){
    v0 = v0*(1+monthlyRate);
    v1 = v1 + monthlyAvailable;
    v2 = (v2 + monthlyAvailable)*(1+monthlyRate);
    s0.push(v0); s1.push(v1); s2.push(v2);
  }

  // Growth chart
  const gc = document.getElementById('growthChart').getContext('2d');
  if (growthChart) growthChart.destroy();
  growthChart = new Chart(gc, {
    type:'line',
    data:{
      labels,
      datasets:[
        { label:'Ohne Sparen', data:s0, tension:.25 },
        { label:'Nur sparen (ohne Zins)', data:s1, tension:.25 },
        { label:'Investieren', data:s2, tension:.25, borderWidth:2 },
        { label:'Ziel', data:Array.from({length: months+1}, _=> goalAmount), borderDash:[6,6], tension:0 }
      ]
    },
    options:{
      responsive:true, maintainAspectRatio:false, aspectRatio:2,
      interaction:{ mode:'index', intersect:false },
      plugins:{
        legend:{ position:'top' },
        tooltip:{ callbacks:{ label:(ctx)=> `${ctx.dataset.label}: ${fmt2.format(ctx.parsed.y)}` } }
      },
      scales:{
        x:{ title:{ display:true, text:'Jahre' }, grid:{ display:false } },
        y:{ title:{ display:true, text:'VermÃ¶gen (â‚¬)' },
            ticks:{ callback:(v)=> fmt0.format(v) } }
      }
    }
  });

  // Split chart
  const contrib = assets + monthlyAvailable*months;
  const gains = Math.max(0, fv_invest - contrib);
  const sc = document.getElementById('splitChart').getContext('2d');
  if (splitChart) splitChart.destroy();
  splitChart = new Chart(sc, {
    type:'doughnut',
    data:{ labels:['Eigene Einzahlungen','ErtrÃ¤ge/Zinseszins'], datasets:[{ data:[Math.max(0,contrib), Math.max(0,gains)] }] },
    options:{
      responsive:true, maintainAspectRatio:false, aspectRatio:2,
      plugins:{
        legend:{ position:'top' },
        tooltip:{ callbacks:{ label:(ctx)=> `${ctx.label}: ${fmt2.format(ctx.parsed)}` } }
      },
      cutout:'58%'
    }
  });
}

// Init
setTimeout(()=> calculate(false), 80);
</script>
</body>
</html>
